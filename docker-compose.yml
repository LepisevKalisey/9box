version: '3.8'

services:
  builder:
    image: node:20-alpine
    working_dir: /src
    environment:
      - NPM_CONFIG_REGISTRY=https://registry.npmjs.org
    command: sh -c "npm install --no-audit --no-fund --legacy-peer-deps && npm run build && npm prune --omit=dev && mkdir -p /out/dist /out/node_modules /out/app && cp -r dist/* /out/dist/ && cp -r node_modules/* /out/node_modules/ && cp -r server.js package.json /out/app/"
    volumes:
      - ./:/src
      - web_dist:/out/dist
      - server_node_modules:/out/node_modules
      - app_src:/out/app
    restart: 'no'

  app:
    image: node:20-alpine
    working_dir: /app
    environment:
      - NODE_ENV=production
      - PORT=3001
      - API_KEY=${API_KEY}
    depends_on:
      - builder
    command: sh -c "node server.js"
    ports:
      - "3001:3001"
    volumes:
      - app_src:/app
      - web_dist:/app/dist
      - server_node_modules:/app/node_modules
      - 9box_data:/app/data
    restart: unless-stopped

volumes:
  web_dist:
    driver: local
  server_node_modules:
    driver: local
  app_src:
    driver: local
  9box_data:
    driver: local

